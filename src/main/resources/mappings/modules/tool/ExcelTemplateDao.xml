<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.management.admin.modules.tool.dao.ExcelTemplateDao">

    <resultMap id="excelTemplateBean" type="com.management.admin.modules.tool.entity.ExcelTemplate">
        <id column="id" property="id"/>
        <result column="template_name" property="templateName"/>
        <result column="excel_name" property="filePath"/>
        <result column="table_name" property="tableName"/>
        <result column="create_date" property="createDate"/>
        <result column="modify_date" property="modifyDate"/>
        <result column="del_flag" property="delFlag"/>
    </resultMap>

    <resultMap id="columnMapFieldBean" type="com.management.admin.modules.tool.entity.ColumnMapField">
        <id column="id" property="id"/>
        <result column="template_id" property="templateId"/>
        <result column="field_name" property="tableColumnName"/>
        <result column="column_name" property="columnName"/>
        <result column="column_index" property="columnIndex"/>
        <result column="create_date" property="createDate"/>
        <result column="modify_date" property="modifyDate"/>
        <result column="del_flag" property="delFlag"/>
    </resultMap>


    <select id="getTableList" resultType="String">
        select `table_name` from information_schema.tables where table_schema="securityManager"
    </select>

    <select id="getTableColumnList" resultType="String">
        select COLUMN_NAME from information_schema.COLUMNS where table_name = #{param1} and table_schema = 'securityManager'
    </select>


    <insert id="insertOrUpdate" parameterType="com.management.admin.modules.tool.entity.ExcelTemplate">
        insert excel_template (id,
                               template_name,
                               table_name,
                               excel_name,
                               create_time,
                               modify_time,
                               del_flag)
        values (#{id},
                #{templateName},
                #{tableName},
                #{filePath},
                #{createTime},
                #{modifyTime},
                #{delFlag})
        on duplicate key update id             = #{id},
                                template_name  = #{templateName},
                                table_name     = #{tableName},
                                excel_name     = #{filePath},
                                create_time    = #{createTime},
                                modify_time    = #{modifyTime},
                                del_flag       = #{delFlag}
    </insert>


    <insert id="insertList" parameterType="com.management.admin.modules.tool.entity.ColumnMapField">
        insert excel_template_map
        (id,
        template_id,
        field_name,
        column_index,
        column_name,
        create_time,
        modify_time,
        del_flag)
        values
        <foreach collection="list" separator="," item="item">
            (#{item.id},
            #{item.templateId},
            #{item.tableColumnName},
            #{item.columnIndex},
            #{item.columnName},
            #{item.createTime},
            #{item.modifyTime},
            #{item.delFlag})
        </foreach>
    </insert>


    <select id="selectAllTemplate" parameterType="com.management.admin.modules.tool.entity.ExcelTemplate" resultMap="excelTemplateBean">
        select a.* from excel_template a
    </select>


    <select id="selectById" parameterType="string" resultMap="excelTemplateBean">
        select *
        from excel_template
        where id = #{param1}
    </select>

    <select id="selectByTemplateId" parameterType="string" resultMap="columnMapFieldBean">
        select *
        from excel_template_map
        where template_id = #{param1}
    </select>

    <insert id="dynamicInsert" parameterType="com.management.admin.modules.tool.entity.DynamicInsertParam">
        insert into ${tableName}
        <foreach collection="fieldList" item="field" index="index" open="(" separator="," close=")">
            ${field}
        </foreach>
        values
        <foreach collection="data" separator="," item="row">
            <foreach collection="row" open="(" close=")" separator="," item="cell">
                #{cell}
            </foreach>
        </foreach>
    </insert>



    <select id="selectFieldListByTableName" parameterType="string" resultType="com.management.admin.modules.tool.entity.tiny.TableField">
        select COLUMN_NAME    as fieldName,
               DATA_TYPE      as fieldType
        from INFORMATION_SCHEMA.Columns
        where TABLE_SCHEMA = (select database()) and table_name = #{tableName}
    </select>

</mapper>